
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Machines That Share a Common CPU Module &#8212; Open Network Install Environment  documentation</title>
    <link rel="stylesheet" href="../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/onie-favicon-16x16.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Source Code Release Cycle" href="release.html" />
    <link rel="prev" title="Demo Diagnostic OS Installer" href="demo_diag.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="release.html" title="Source Code Release Cycle"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="demo_diag.html" title="Demo Diagnostic OS Installer"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Open Network Install Environment  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">For Developers</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
  <a href="
      ../index.html" class="logo">
  
  <img src="../_static/ONIE-logo-green-160x60.png" class="logo" />
  </a>
  <center><a href="https://github.com/opencomputeproject/onie" class="logo">
  <svg class="octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
  opencomputeproject/onie</a></center>

<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../download/index.html">Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../news/index.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design-spec/index.html">Design Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html">Unit Testing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">For Developers</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="building.html">Build Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="building.html#source-code-description">Source Code Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Basic Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html">Contributing to ONIE</a></li>
<li class="toctree-l2"><a class="reference internal" href="porting.html">Porting Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo_os.html">Demo OS Installer and OS Runtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo_diag.html">Demo Diagnostic OS Installer</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Machines That Share a Common CPU Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="release.html">Source Code Release Cycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="project_lead_tasks.html">Project Lead Tasks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Contents</h2>
    <div class="sidebar-localtoc">
      <ul>
<li><a class="reference internal" href="#">Machines That Share a Common CPU Module</a><ul>
<li><a class="reference internal" href="#one-onie-image-for-the-cpu-module">One ONIE Image for the CPU Module</a></li>
<li><a class="reference internal" href="#changes-to-etc-machine-conf">Changes to <code class="docutils literal notranslate"><span class="pre">/etc/machine.conf</span></code></a></li>
<li><a class="reference internal" href="#how-this-affects-onie-updates">How This Affects ONIE Updates</a></li>
<li><a class="reference internal" href="#working-example">Working Example</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../index.html">Home</a></li>
              
                <li><a href="index.html">For Developers</a></li>
              
              <li>Machines That Share a Common CPU Module</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="machines-that-share-a-common-cpu-module">
<span id="multiple-cpu"></span><h1>Machines That Share a Common CPU Module<a class="headerlink" href="#machines-that-share-a-common-cpu-module" title="Permalink to this headline">¶</a></h1>
<p>Hardware vendors often ask how best to support ONIE on a family of
machines that all share a common CPU module.  This section describes
infrastructure available in ONIE to help with this reality.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The infrastructure described in this section first became available
with the 2017.11 release.</p>
</div>
<p>The hardware systems consist of a pluggable CPU module and a “base
board” that contains the switching ASIC silicon and front panel ports.</p>
<p>The CPU module contains the main CPU subsystems, including the CPU,
DRAM, storage (like mSATA and nvme m.2), CPLDs, eth0, serial console,
etc.</p>
<p>This design makes great sense for a hardware manufacturer – they can
mass produce the CPU module independently of the base boards, allowing
them to support a variety of switching ASICs with a single CPU module.</p>
<p>The question in an ONIE environment is “how to identify the machine?”
when the CPU module is common.  The hardware vendors would like to
build ONIE once, just for the CPU module.  It complicates their life
to tailor an ONIE build for each base board variant.</p>
<p>At the same time NOS vendors need a clean way to identify the system.
If 10 different systems with a common CPU module all report
“x86_64-vendor_common_cpuXYZ-r0” for 10 different base boards that is
not helpful.  It complicates the NOS vendor’s life to add vendor and
platform specific “peek and poke” code to their installers to figure
out what the base board is.</p>
<p>At a hardware level, the base board identifying information is
typically contained in the ONIE EEPROM, using one of the optional TLV
types like “Part Number”(0x22) or “Product Name”(0x21).  Sometimes the
information is contained in a CPLD.  The details of the identifying
information is not so important for this discussion.</p>
<div class="section" id="one-onie-image-for-the-cpu-module">
<h2>One ONIE Image for the CPU Module<a class="headerlink" href="#one-onie-image-for-the-cpu-module" title="Permalink to this headline">¶</a></h2>
<p>The idea is to have a single ONIE “machine” for the CPU module and
detect at run time what the baseboard is.</p>
<p>The platform identification originates from <code class="docutils literal notranslate"><span class="pre">/etc/machine.conf</span></code>, a
portion of which is now derived at run time.  Along with this a new
configuration variable, <code class="docutils literal notranslate"><span class="pre">onie_build_machine</span></code> is introduced.</p>
</div>
<div class="section" id="changes-to-etc-machine-conf">
<h2>Changes to <code class="docutils literal notranslate"><span class="pre">/etc/machine.conf</span></code><a class="headerlink" href="#changes-to-etc-machine-conf" title="Permalink to this headline">¶</a></h2>
<p>Previously this file was entirely built at compile time.  This file is
now a small wrapper script that sources two new files,
<code class="docutils literal notranslate"><span class="pre">/etc/machine-build.conf</span></code> and <code class="docutils literal notranslate"><span class="pre">/etc/machine-live.conf</span></code>.</p>
<p>The contents of <code class="docutils literal notranslate"><span class="pre">/etc/machine.conf</span></code> looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Source build-time machine configuration
. /etc/machine-build.conf

# Source run-time machine configuration if available
[ -r /etc/machine-live.conf ] &amp;&amp; . /etc/machine-live.conf

# Use onie_machine if set, otherwise use build_machine
onie_machine=${onie_machine:-$onie_build_machine}

onie_platform=&quot;${onie_arch}-${onie_machine}-r${onie_machine_rev}&quot;
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">/etc/machine-build.conf</span></code> – this file is completely built at
<strong>compile time</strong> and only contains information known at build time.
This file introduces a new configuration variable,
<code class="docutils literal notranslate"><span class="pre">onie_build_machine</span></code>, which is the ONIE machine specified at compile
time.  For example this would be the ONIE machine name of the common
CPU module.</li>
<li><code class="docutils literal notranslate"><span class="pre">/etc/machine-live.conf</span></code> – this file is built at <strong>run time</strong>.  A
boot time init script sources a platform specific file if it exists,
executes the <code class="docutils literal notranslate"><span class="pre">gen_live_config()</span></code> function and stores the output in
<code class="docutils literal notranslate"><span class="pre">/etc/machine-live.conf</span></code>.  By default this function outputs nothing,
but a platform can override it produce a runtime ONIE machine name.</li>
</ul>
<p>Using this mechanism, a machine can redefine <code class="docutils literal notranslate"><span class="pre">onie_machine</span></code> and
<code class="docutils literal notranslate"><span class="pre">onie_switch_asic</span></code> at run time.  To do this, a machine defines a
small script in the source tree at
<code class="docutils literal notranslate"><span class="pre">machine/&lt;vendor&gt;/rootconf/sysroot-lib-onie/gen-config-platform</span></code>,
which include a definition of the <code class="docutils literal notranslate"><span class="pre">gen_live_config()</span></code> function.</p>
<p>If a machine does not define <code class="docutils literal notranslate"><span class="pre">gen-config-platform</span></code>,
i.e. <code class="docutils literal notranslate"><span class="pre">/etc/machine-live.conf</span></code> is empty, then the contents of
<code class="docutils literal notranslate"><span class="pre">onie_build_machine</span></code> is used to set <code class="docutils literal notranslate"><span class="pre">onie_machine</span></code>.  This is
backwardly compatible with how ONIE worked previously.</p>
</div>
<div class="section" id="how-this-affects-onie-updates">
<h2>How This Affects ONIE Updates<a class="headerlink" href="#how-this-affects-onie-updates" title="Permalink to this headline">¶</a></h2>
<p>When ONIE updates itself, it will now check that the running
<code class="docutils literal notranslate"><span class="pre">onie_build_machine</span></code> matches the <code class="docutils literal notranslate"><span class="pre">onie_build_machine</span></code> of the
proposed update image.  Previously it checked that <code class="docutils literal notranslate"><span class="pre">onie_machine</span></code>
matched between runtime and the image.</p>
</div>
<div class="section" id="working-example">
<h2>Working Example<a class="headerlink" href="#working-example" title="Permalink to this headline">¶</a></h2>
<p>For an example look at the <code class="docutils literal notranslate"><span class="pre">kvm_x86_64</span></code> virtual machine.  This
machine contains an example <code class="docutils literal notranslate"><span class="pre">sysroot-lib-onie/gen-config-platform</span></code>
file that can dynamically generate different run time machine names
based on the environment.</p>
<p>To try out the kvm_x86_64 example, set the <code class="docutils literal notranslate"><span class="pre">live_machine</span></code> and
<code class="docutils literal notranslate"><span class="pre">live_asic</span></code> variables on the GRUB command line when booting ONIE.
At boot time the kvm_x86_64 machine detects these and dynamically
generates a run time machine name.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is just a toy example.  For a real hardware platform, the base
board identifying information is typically contained in the ONIE
EEPROM, using one of the optional TLV types like “Part
Number”(0x22) or “Product Name”(0x21).  Sometimes the information
is contained in a CPLD.</p>
</div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="demo_diag.html" title="previous chapter (use the left arrow)">Demo Diagnostic OS Installer</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="release.html" title="next chapter (use the right arrow)">Source Code Release Cycle</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="release.html" title="Source Code Release Cycle"
             >next</a> |</li>
        <li class="right" >
          <a href="demo_diag.html" title="Demo Diagnostic OS Installer"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Open Network Install Environment  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >For Developers</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>
  <div class="footer">
        &copy; Copyright 2013-2018, <a href="https://cumulusnetworks.com/">Cumulus Networks, Inc.</a>  All Rights Reserved.
  </div>
  </body>
</html>